name: Stable Release & Bump

on:
  workflow_dispatch: # Trigger manually when ready to release

jobs:
  release:
    runs-on: ubuntu-latest
    permissions:
      contents: write # REQUIRED to push commits/tags back to repo
      packages: write # REQUIRED to deploy artifact

    steps:
      - uses: actions/checkout@v4

      - name: Set up JDK 25
        uses: actions/setup-java@v4
        with:
          java-version: '25'
          distribution: 'temurin'
          server-id: github

      - name: Configure Git User
        run: |
          git config --global user.email "action@github.com"
          git config --global user.name "GitHub Action"

      # RELEASE STABLE

      - name: Prepare Stable Version
        id: stable_vars
        run: |
          # Get current version (e.g., 1.0.0-SNAPSHOT)
          CURRENT_VERSION=$(mvn help:evaluate -Dexpression=project.version -q -DforceStdout)
          
          # Strip -SNAPSHOT to get 1.0.0
          RELEASE_VERSION=${CURRENT_VERSION%-SNAPSHOT}
          
          echo "Releasing version: $RELEASE_VERSION"
          echo "release_version=$RELEASE_VERSION" >> $GITHUB_ENV
          
          # Set the POM to the stable version
          mvn versions:set -DnewVersion=$RELEASE_VERSION -DgenerateBackupPoms=false

      - name: Deploy Stable Artifact
        run: mvn deploy
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Commit and Tag Release
        run: |
          git commit -am "Release ${{ env.release_version }}"
          git tag -a v${{ env.release_version }} -m "Release ${{ env.release_version }}"
          git push origin v${{ env.release_version }}

      # BUMP TO NEXT SNAPSHOT

      - name: Bump to Next Snapshot
        run: |
          
          VERSION=${{ env.release_version }}
          IFS='.' read -r -a parts <<< "$VERSION"
          MAJOR=${parts[0]}
          MINOR=${parts[1]}
          PATCH=${parts[2]}
          
          # Increment Patch
          NEW_PATCH=$((PATCH + 1))
          NEXT_SNAPSHOT="${MAJOR}.${MINOR}.${NEW_PATCH}-SNAPSHOT"
          
          echo "Bumping to: $NEXT_SNAPSHOT"
          
          # Set POM to new Snapshot
          mvn versions:set -DnewVersion=$NEXT_SNAPSHOT -DgenerateBackupPoms=false
          
          # Commit and Push to Main
          git commit -am "Bump version to $NEXT_SNAPSHOT"
          git push origin main
